<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>MtG SimpleScore</title>

<style>
* {margin: 0; padding: 0;}
html {font-family: droid sans, sans-serif; padding: 0 1%; }
h1 {margin: 5px 1%; font-size: 18px; }
.article {position: fixed; width: 99%; top: 5px; }
.article > p {float: right; padding: 5px 3% 0 0; }

/* Buttons */
fieldset {
    margin: 0 1%; padding: 5px 2% 10px;
    width: 43.5%;
    float: left;
    font-size: 24px;
    border: 0 none;
    background: #333; 
    color: #fff; 
}
legend {padding: 0 4px; background: #333; border-radius: 5px; font-size: 18px; }
fieldset p {width: 30%; float: left; text-align: center; margin: 0; color: #fcc; }

h5 {width: 19%; cursor: pointer; }
h5, select {
    background: #ddd;
    border-radius: 5px;
    float: left;
    text-align: center;
    color: #000;
}
select {font-size: 50%; width: 13.5%;  margin: 0 1%; }
select:focus {outline: 0 none; }

/* Poison */
label {display: block; clear: both; padding-top: .5em; font-size: 80%; }
div.poison {font-size: 70%; padding: 0; width: 80%; margin: 0 23%; }
div.poison label {padding-top: 0.5em; }
div.poison p {width: 20%; color: #0e0; }

/* Log */
#record {padding-top: 145px; }
#record > div {
    margin: 0 1%; padding: 10px 2%;
    width: 43%;
    float: left;
    border: 1px solid #fff;
    overflow: auto;
}
#record p {text-align: left; color: #700; }
#record p.poison {color: #0c0; text-align: right; }
#me_record {margin-right: 3%; }

</style>

<body>
<div class="article">

<p><a href="?start=20">Reset 20</a> <a href="?start=30">30</a> <a href="?start=40">40</a></p>
<h1>MtG SimpleScore</h1>

<fieldset id="me">
<legend>Me</legend>
<div class="life">
<select id="selectMeMinus"></select>
<h5 onclick="changeScore('me', -1, 0)">-1</h5>
<p>20</p>
<h5 onclick="changeScore('me', 1, 0)">+1</h5>
<select id="selectMePlus"></select>
</div>

<div class="poison">
<label>Poison</label>
<h5 onclick="changeScore('me', -1, 1)">-1</h5>
<p>0</p>
<h5 onclick="changeScore('me', 1, 1)">+1</h5>
</div>
</fieldset>

<fieldset id="you">
<legend>You</legend>
<div class="life">
<select id="selectYouMinus"></select>
<h5 onclick="changeScore('you', -1, 0)">-1</h5>
<p>20</p>
<h5 onclick="changeScore('you', 1, 0)">+1</h5>
<select id="selectYouPlus"></select>
</div>

<div class="poison">
<label>Poison</label>
<h5 onclick="changeScore('you', -1, 1)">-1</h5>
<p>0</p>
<h5 onclick="changeScore('you', 1, 1)">+1</h5>
</div>
</fieldset>

</div>

<div id="record">
<div id="me_record">
<p>20</p>
</div>
<div id="you_record">
<p>20</p>
</div>
</div>

<script>
/*jslint browser: true, sloppy: true */
var timerRecord, lastRecorded = {};
lastRecorded.poison = {};

function Q$(name) {
    var reQs, val;
    reQs = new RegExp("[\\?&]" + name + "=([^&#]*)", "i");
    val = reQs.exec(window.parent.location.search);
    if (val) {
        return decodeURIComponent(val[1]);
    }
    return "";
}

function log(player, currentScore, scoreChange, type) {
    var recordTally, logEntry, scoreChangePrefix = '';
    if (scoreChange) {
        recordTally = document.getElementById(player + '_record');
        logEntry = document.createElement('p');

        if (scoreChange > 0) {
            scoreChangePrefix = '+';
        }
        logEntry.innerHTML = currentScore + ' (' + scoreChangePrefix + scoreChange + ')';
        if (type === 'poison') {
            logEntry.className = 'poison';
            lastRecorded.poison[player] = currentScore;
        } else {
            lastRecorded[player] = currentScore;
        }

        recordTally.appendChild(logEntry);
    }
}

function newRecord(player) {
    var scores = document.querySelectorAll('#' + player + ' p'),
        currentScore = scores[0].innerHTML,
        currentScorePoison = scores[1].innerHTML,
        scorechangeMain = currentScore - lastRecorded[player],
        scorechangePoison = currentScorePoison - lastRecorded.poison[player];

    log(player, currentScore, scorechangeMain);
    log(player, currentScorePoison, scorechangePoison, 'poison');
}

function record() {
    newRecord('me');
    newRecord('you');
}

function recordTimer() {
    if (timerRecord) {
        clearTimeout(timerRecord);
    }
    timerRecord = window.setTimeout(record, 1100);
}

function changeScore(player, scorechange, scoreType) {
    var playerFields = document.getElementById(player),
        playerScore = playerFields.getElementsByTagName('p'),
        immediateUpdate = false,
        currentScore,
        newScore;

    if (scoreType === 2) {
        immediateUpdate = true;
        scoreType = 0;
    }
    currentScore = +playerScore[scoreType].innerHTML;

    newScore = +scorechange + currentScore;
    playerScore[scoreType].innerHTML = newScore;
    if (immediateUpdate) {
        if (timerRecord) {
            clearTimeout(timerRecord);
        }
        record();
    } else {
        recordTimer();
    }
}

function init() {
    var startingLife = Q$('start') || 20, multiMax = 20;
    startingLife = +startingLife;

    function multiScore() {
        var player = 'me';
        if (this.id.indexOf('You') > -1) {
            player = 'you';
        }
        changeScore(player, this.value, 2);
        this.selectedIndex = 0;
    }

    // Build multiselect dropdowns
    function addOptions(el, plusOrMinus) {
        var ii, option, mod = 1;

        if (plusOrMinus === '-') {
            mod = -1;
        }

        function signAndVal(val, sign) {
            if (val === 0) {
                return 0;
            }
            return sign + val;
        }

        for (ii = 0; ii <= multiMax; ii = ii + 1) {
            option = document.createElement('option');
            option.value = ii * mod;
            option.innerHTML = signAndVal(ii, plusOrMinus);
            el.appendChild(option);
        }
        el.addEventListener('change', multiScore);
    }
    addOptions(document.getElementById('selectMeMinus'), '-');
    addOptions(document.getElementById('selectMePlus'), '+');
    addOptions(document.getElementById('selectYouMinus'), '-');
    addOptions(document.getElementById('selectYouPlus'), '+');

    lastRecorded.me = startingLife;
    lastRecorded.you = startingLife;
    lastRecorded.poison.me = 0;
    lastRecorded.poison.you = 0;

    document.querySelector('#me p').innerHTML = startingLife;
    document.querySelector('#you p').innerHTML = startingLife;
    document.querySelector('#me_record p').innerHTML = startingLife;
    document.querySelector('#you_record p').innerHTML = startingLife;
}

init();

</script>
